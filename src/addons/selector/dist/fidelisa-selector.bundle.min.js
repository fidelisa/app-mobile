(function (doc, cssText) {
    var styleEl = doc.createElement("style");
    doc.getElementsByTagName("head")[0].appendChild(styleEl);
    if (styleEl.styleSheet) {
        if (!styleEl.styleSheet.disabled) {
            styleEl.styleSheet.cssText = cssText;
        }
    } else {
        try {
            styleEl.innerHTML = cssText;
        } catch (ignore) {
            styleEl.innerText = cssText;
        }
    }
}(document, ""));

(function(module) {
try {
  module = angular.module('fidelisa-selector.templates');
} catch (e) {
  module = angular.module('fidelisa-selector.templates', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('fidelisa-selector-modal.html',
    '<ion-modal-view class="fd_selector_modal">\n' +
    '  <ion-header-bar class="header">\n' +
    '    <h1 class="title">TODO</h1>\n' +
    '  </ion-header-bar>\n' +
    '  <ion-content class="fd-selector-modal-content">\n' +
    '    <div>\n' +
    '      <div class="fd-selector-search" ng-show="search" ng-class="{\'focused\' : searchHasFocus}">\n' +
    '        <div class="item item-input">\n' +
    '          <i class="icon ion-search placeholder-icon"></i>\n' +
    '          <input type="text" ng-focus="searchFocus($event)" ng-blur="searchBlur($event)"\n' +
    '            ng-model="searchText"  placeholder="{{\'Recherche\'|translate}}">\n' +
    '        </div>\n' +
    '        <div class=\'fd-selector-search-ok\' ng-show="searchHasFocus" translate>OK</div>\n' +
    '      </div>\n' +
    '      <div class="fd-selector-list" ng-class="{ \'has-selector-search\': search }">\n' +
    '        <div class="item item-icon-right" ng-click="pickID(el.uuid)" ng-style=\'el.style\' ng-repeat="el in elements | filter:searchText " >\n' +
    '          <i class="icon" ng-class="buttonStyle(el)"></i>\n' +
    '          {{el.title}}\n' +
    '        </div>\n' +
    '      </div>\n' +
    '    </div>\n' +
    '  </ion-content>\n' +
    '  <ion-footer-bar class="footer">\n' +
    '    <div class="row padding_zero">\n' +
    '      <button class="button button-clear button-block button_set"\n' +
    '              ng-click="setFidelisaSelector()">{{mainObj.setLabel}}\n' +
    '      </button>\n' +
    '      <button class="button button-clear button-block button_close"\n' +
    '              ng-click="closeFidelisaSelector()">{{mainObj.closeLabel}}\n' +
    '      </button>\n' +
    '    </div>\n' +
    '  </ion-footer-bar>\n' +
    '</ion-modal-view>\n' +
    '');
}]);
})();

(function(module) {
try {
  module = angular.module('fidelisa-selector.templates');
} catch (e) {
  module = angular.module('fidelisa-selector.templates', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('fidelisa-selector-popup.html',
    '<div>\n' +
    '  <div class="fd-selector-search" ng-show="search" ng-class="{\'focused\' : searchHasFocus}">\n' +
    '    <div class="item item-input">\n' +
    '      <i class="icon ion-search placeholder-icon"></i>\n' +
    '      <input type="text" ng-focus="searchFocus($event)" ng-blur="searchBlur($event)"\n' +
    '        ng-model="searchText"  placeholder="{{\'Recherche\'|translate}}">\n' +
    '    </div>\n' +
    '    <div class=\'fd-selector-search-ok\' ng-show="searchHasFocus" translate>OK</div>\n' +
    '  </div>\n' +
    '  <div class="fd-selector-list" ng-class="{ \'has-selector-search\': search }">\n' +
    '    <div class="item item-icon-right" ng-click="pickID(el.uuid)" ng-style=\'el.style\' ng-repeat="el in elements | filter:searchText " >\n' +
    '      <i class="icon" ng-class="buttonStyle(el)"></i>\n' +
    '      {{el.title}}\n' +
    '    </div>\n' +
    '  </div>\n' +
    '</div>\n' +
    '');
}]);
})();

angular.module('fidelisa-selector', [
  'ionic',
  'fidelisa-selector.service',
  'fidelisa-selector.provider',
  'fidelisa-selector.templates'
]);

angular.module('fidelisa-selector.provider', [])

  .provider('fidelisaSelector', function () {

    var config = {
      titleLabel: null,
      setLabel: 'Set',
      closeLabel: 'Close',

      templateType: 'popup',
      closeOnSelect: false,

      search: false,

      multi: true,
      selectedElements: [],
      elements: [],
      multiCheckIcon: 'ion-ios-circle-filled',
      mutliUncheckIcon: 'ion-ios-circle-outline',
      monoCheckIcon: 'ion-ios-checkmark-outline',
      monoUncheckIcon: '',

      popupCss: ''

    };

    this.configFidelisaSelector = function (inputObj) {
      angular.extend(config, inputObj);
    };

    this.$get = ['$rootScope', '$ionicPopup', '$ionicModal', '$window', '$timeout',
    function ($rootScope, $ionicPopup, $ionicModal, $window, $timeout) {

      var $scope = $rootScope.$new();

      $scope.searchHasFocus = false;

      var isSelected = function(idx) {
        if (angular.isDefined(idx)) {
          return $scope.selectedElements.indexOf(idx);
        }
        return -1;
      }

      $scope.buttonStyle = function(el) {
        if (angular.isUndefined(el)) {
          return "";
        }

        if ($scope.multi) {
          if (isSelected(el.uuid) > -1) { return $scope.mainObj.multiCheckIcon; }
          else { return $scope.mainObj.mutliUncheckIcon; }
        } else {
          if (isSelected(el.uuid) > -1) { return $scope.mainObj.monoCheckIcon; }
          else { return $scope.mainObj.monoUncheckIcon; }
        }
      }

      $scope.pickID = function(elID) {
        if (!$scope.multi) {
          $scope.selectedElements = [];
        }
        if (angular.isDefined(elID)) {
          var index = isSelected(elID);
          if (index > -1) {
              $scope.selectedElements.splice(index, 1);
          } else {
              $scope.selectedElements.push(elID);
          }
        }

        if ($scope.mainObj.closeOnSelect) {
          if ($scope.mainObj.closeOnSelect) {
            $scope.mainObj.callback($scope.selectedElements);
            if ($scope.mainObj.templateType.toLowerCase() == 'popup') {
              $scope.popup.close();
            } else {
              closeModal();
            }
          }
        }
      }

      var provider = {};

      //Setting up the initial object
      function setInitialObj(ipObj) {
        $scope.mainObj = angular.copy(ipObj);
        $scope.selectedElements = [].concat(ipObj.selectedElements);
        $scope.elements = [].concat(ipObj.elements);
        $scope.multi = $scope.mainObj.multi ;
        $scope.search = $scope.mainObj.search ;
      }

      $ionicModal.fromTemplateUrl('fidelisa-selector-modal.html', {
        scope: $scope,
        animation: 'slide-in-up'
      }).then(function (modal) {
        $scope.modal = modal;
      });

      $scope.$on('$destroy', function () {
        $scope.modal.remove();
      });

      function openModal() {
        $scope.modal.show();
      }

      function closeModal() {
        $scope.modal.hide();
      }

      $scope.closeFidelisaSelector = function closeFidelisaSelector() {
        closeModal();
      };

      var focusedElement;

      $scope.searchFocus = function searchFocus($event) {
        console.log("focus");
        $scope.searchHasFocus = true;
      }

      $scope.searchBlur = function searchBlur($event) {
        console.log("blur");
        $timeout(function() {
            $scope.searchHasFocus = false;
        }, 500); // timeout avoid keyboard re-opening
      }

      //Open selector
      provider.openFidelisaSelector = function (ipObj) {
        var buttons = [];

        $scope.mainObj = angular.extend({}, config, ipObj);

        setInitialObj($scope.mainObj);

        if (!$scope.mainObj.closeOnSelect) {
          buttons = [{
            text: $scope.mainObj.setLabel,
            type: 'button_set',
            onTap: function (e) {
              $scope.mainObj.callback($scope.selectedElements);
            }
          }];
        }

        buttons.push({
          text: $scope.mainObj.closeLabel,
          type: 'button_close'
        });

        if ($scope.mainObj.templateType.toLowerCase() == 'popup') {
          $scope.popup = $ionicPopup.show({
            title: $scope.mainObj.titleLabel,
            templateUrl: 'fidelisa-selector-popup.html',
            scope: $scope,
            cssClass: $scope.mainObj.popupCss,
            buttons: buttons
          });
        } else {
          openModal();
        }
      };

      return provider;

    }];

  });

angular.module('fidelisa-selector.service', [])

  .service('FidelisaSelectorService', function () {

    
  });
